<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Thumbnail Generator</title>
    <!-- Add Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        padding: 20px;
      }
      input,
      textarea,
      select {
        width: 100%;
        padding: 8px;
        margin-bottom: 8px;
        border: 1px solid #ccc;
        border-radius: 4px;
      }
      textarea {
        height: 80px;
        resize: vertical;
      }
      button {
        background-color: #18a0fb;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        width: 100%;
      }
      button:hover {
        background-color: #0d8de3;
      }
      .control-group {
        margin-bottom: 16px;
      }
      .control-group label {
        display: block;
        margin-bottom: 4px;
        font-size: 12px;
        color: #333;
      }
      .row {
        display: flex;
        gap: 8px;
        margin-bottom: 8px;
      }
      .row > * {
        flex: 1;
      }
      /* Add new styles */
      .section-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 8px;
      }

      .header-left {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .status-text {
        font-size: 11px;
        color: #666;
      }

      .toggle-button {
        background-color: #f5f5f5;
        border: 1px solid #ddd;
        padding: 4px 8px;
        cursor: pointer;
        color: #333;
        width: auto;
        display: flex;
        align-items: center;
        gap: 4px;
        border-radius: 4px;
        transition: all 0.2s ease;
      }

      .toggle-button:hover {
        background-color: #e8e8e8;
        color: #18a0fb;
      }

      .toggle-button.active {
        background-color: #e3f2fd;
        color: #18a0fb;
        border-color: #18a0fb;
      }

      .toggle-text {
        font-size: 12px;
        font-weight: 500;
      }

      .description-section {
        display: none;
      }

      .description-section.active {
        display: block;
      }

      i {
        font-size: 16px;
      }

      /* Updated Preview styles */
      .preview-container {
        margin-bottom: 24px;
        border-radius: 8px;
        overflow: hidden;
        background: none;
      }

      .preview-header {
        padding: 8px 12px;
        background-color: #1e1e1e;
        font-size: 12px;
        color: #ffffff;
        display: flex;
        justify-content: center;
        align-items: center;
        border-radius: 8px 8px 0 0;
      }

      .preview-canvas {
        position: relative;
        width: 280px;
        height: 140px;
        margin: 0 auto;
        background: #ffffff;
        border-radius: 0 0 8px 8px;
        overflow: hidden;
      }

      .preview-canvas.with-gradient::after {
        content: "";
        position: absolute;
        left: 0;
        right: 0;
        top: 0;
        bottom: 0;
        background: linear-gradient(
          180deg,
          rgba(0, 0, 0, 0) 0%,
          rgba(0, 0, 0, 0.7) 100%
        );
        pointer-events: none;
      }

      .preview-content {
        position: absolute;
        left: 22px; /* Scaled from 160px (160 * 280/1920 ≈ 22) */
        right: 22px;
        transition: all 0.3s ease;
      }

      .preview-heading {
        font-family: inherit;
        word-break: break-word;
        line-height: 1.2;
        margin-bottom: 3px;
        color: #000000; /* Default black color */
      }

      .preview-description {
        font-family: inherit;
        word-break: break-word;
        line-height: 1.4;
        opacity: 1; /* Changed from 0.8 to 1 for better visibility */
        color: #000000; /* Default black color */
      }

      /* Remove the safe area visual guide since it's not shown in Figma's UI */
      .safe-area {
        display: none;
      }

      .background-section,
      .heading-section {
        display: none;
      }

      .background-section.active,
      .heading-section.active {
        display: block;
      }

      .color-input-group {
        flex: 1;
      }

      .gradient-toggle {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 4px;
      }

      .gradient-toggle input[type="checkbox"] {
        width: auto;
        margin: 0;
      }

      /* Update preview styles */
      .preview-canvas {
        background: white;
      }

      .preview-canvas.with-gradient::after {
        content: "";
        position: absolute;
        left: 0;
        right: 0;
        top: 0;
        bottom: 0;
        background: linear-gradient(
          180deg,
          rgba(0, 0, 0, 0) 0%,
          rgba(0, 0, 0, 0.7) 100%
        );
        pointer-events: none;
      }

      .position-select {
        width: auto;
        min-width: 100px;
      }

      .position-row {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 8px;
      }

      .position-row label {
        margin-bottom: 0;
        white-space: nowrap;
      }

      .position-input-group {
        flex: 1;
      }

      .position-input-group select {
        width: 100%;
      }

      /* Remove tag-related styles */
      /* .tags-section,
      .tag-item,
      .tag-header,
      .tag-title,
      .remove-tag,
      .add-tag-button {
        display: none;
      } */

      /* Add these styles and remove the display: none from existing tag styles */
      .tags-section {
        display: none;
      }

      .tags-section.active {
        display: block;
      }

      .tag-item {
        background: #f5f5f5;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 8px;
        margin-bottom: 8px;
        display: block; /* Make sure it's visible */
      }

      .tag-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
      }

      .tag-title {
        font-size: 12px;
        font-weight: 500;
        color: #333;
        display: block;
      }

      .remove-tag {
        background: none;
        border: none;
        color: #666;
        padding: 4px;
        cursor: pointer;
        width: auto;
        display: flex;
        align-items: center;
      }

      .remove-tag:hover {
        color: #ff4444;
        background: none;
      }

      .add-tag-button {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 4px;
        margin-top: 8px;
      }

      .contributors-section {
        display: none;
      }

      .contributors-section.active {
        display: block;
      }

      .contributor-item {
        background: #f5f5f5;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 8px;
        margin-bottom: 8px;
      }

      .contributor-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
      }

      .contributor-preview {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .contributor-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: #ddd;
      }

      .display-options {
        margin: 12px 0;
      }

      .display-mode-select {
        width: 100%;
      }

      .add-contributor-button {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 4px;
        margin-top: 8px;
      }

      .ai-section {
        margin-top: 16px;
        padding: 16px;
        background: #f9fafb;
        border-radius: 8px;
        border: 1px solid #eee;
      }

      .ai-prompt {
        min-height: 80px;
        margin-bottom: 12px;
      }

      .ai-options {
        margin-bottom: 12px;
      }

      .checkbox-label {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
        color: #333;
      }

      .checkbox-label input[type="checkbox"] {
        width: auto;
        margin: 0;
      }

      .ai-generate-button {
        background-color: #6366f1;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
      }

      .ai-generate-button:hover {
        background-color: #4f46e5;
      }

      .ai-status {
        margin-top: 12px;
        font-size: 14px;
        color: #666;
      }

      .ai-status.loading {
        display: flex;
        align-items: center;
        gap: 8px;
        color: #6366f1;
      }

      .ai-status.error {
        color: #ef4444;
      }

      .ai-status.success {
        color: #22c55e;
      }

      .ask-ai-button {
        margin-top: 8px;
        background-color: #6366f1;
      }

      .ask-ai-button:hover {
        background-color: #4f46e5;
      }

      .ai-modal {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: white;
        padding: 20px;
        z-index: 100;
      }

      .ai-modal.hidden {
        display: none;
      }

      .ai-modal-header {
        display: flex;
        align-items: center;
        margin-bottom: 20px;
        gap: 12px;
      }

      .ai-modal-header h3 {
        margin: 0;
      }

      .back-button {
        background: none;
        border: none;
        color: #666;
        padding: 4px;
        width: auto;
        display: flex;
        align-items: center;
        gap: 4px;
        cursor: pointer;
        font-size: 14px;
      }

      .back-button:hover {
        color: #333;
        background: none;
      }

      .breadcrumb {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 20px;
        padding: 8px 0;
        border-bottom: 1px solid #eee;
      }

      .breadcrumb-item {
        display: flex;
        align-items: center;
        gap: 4px;
        font-size: 14px;
        color: #666;
      }

      .breadcrumb-item.active {
        color: #333;
        font-weight: 500;
      }

      button.breadcrumb-item {
        background: none;
        border: none;
        padding: 4px 8px;
        width: auto;
        cursor: pointer;
        color: #6366f1;
      }

      button.breadcrumb-item:hover {
        background: #f3f4f6;
        border-radius: 4px;
      }

      .breadcrumb-separator {
        color: #666;
        font-size: 12px;
      }

      .ai-content {
        animation: slideIn 0.3s ease;
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateX(10px);
        }
        to {
          opacity: 1;
          transform: translateX(0);
        }
      }

      .hidden {
        display: none;
      }

      .pages-container {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        overflow-y: auto;
      }

      .page {
        display: none;
        padding: 20px;
        min-height: 100%;
      }

      .page.active {
        display: block;
      }

      .page-header {
        display: flex;
        align-items: center;
        gap: 16px;
        margin-bottom: 24px;
        padding-bottom: 16px;
        border-bottom: 1px solid #eee;
      }

      .page-header h3 {
        margin: 0;
        font-size: 16px;
        font-weight: 600;
      }

      .back-button {
        background: none;
        border: none;
        color: #666;
        padding: 4px 8px;
        width: auto;
        display: flex;
        align-items: center;
        gap: 4px;
        cursor: pointer;
        font-size: 14px;
      }

      .back-button:hover {
        color: #333;
        background: #f5f5f5;
        border-radius: 4px;
      }

      .ai-content {
        animation: fadeIn 0.3s ease;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      /* Update button positions */
      #generate, #askAI {
        position: sticky;
        bottom: 20px;
        margin-top: 16px;
      }

      .ask-ai-button {
        margin-top: 8px;
        background-color: #6366f1;
      }

      .ask-ai-button:hover {
        background-color: #4f46e5;
      }

      /* Update button positions */
      .button-container {
        margin-top: 24px;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      /* Remove old button margins */
      #generate, #askAI {
        margin-top: 0;
      }

      .button-container {
        margin-top: 24px;
      }

      .ask-ai-button {
        margin-top: 24px;
        background-color: #6366f1;
      }

      .ask-ai-button:hover {
        background-color: #4f46e5;
      }

      #generate {
        margin-top: 0;
      }
    </style>
  </head>
  <body>
    <h3>Create Thumbnail</h3>

    <div class="preview-container">
      <div class="preview-header">
        Preview
      </div>
      <div class="preview-canvas">
        <div class="preview-content">
          <div class="preview-heading"></div>
          <div class="preview-description"></div>
        </div>
      </div>
    </div>

    <!-- Background Section -->
    <div class="control-group">
      <div class="section-header">
        <div class="header-left">
          <label>Background</label>
        </div>
        <button class="toggle-button" id="toggleBackground" title="Toggle Background">
          <i class="ph-bold ph-eye-slash"></i>
          <span class="toggle-text">Show</span>
        </button>
      </div>
      <div class="background-section" id="backgroundSection">
        <div class="row">
          <div class="color-input-group">
            <label>Color</label>
            <input type="color" id="backgroundColor" value="#FFFFFF" />
          </div>
          <div class="gradient-toggle">
            <label>Gradient Overlay</label>
            <input type="checkbox" id="gradientOverlay" />
          </div>
        </div>
      </div>
    </div>

    <!-- Heading Section -->
    <div class="control-group">
      <div class="section-header">
        <div class="header-left">
          <label>Heading</label>
        </div>
        <button class="toggle-button" id="toggleHeading" title="Toggle Heading">
          <i class="ph-bold ph-eye-slash"></i>
          <span class="toggle-text">Show</span>
        </button>
      </div>
      <div class="heading-section" id="headingSection">
        <textarea id="heading" placeholder="Enter heading text"></textarea>
        <div class="row">
          <div class="position-input-group">
            <label>Position</label>
            <select id="headingPosition">
              <option value="top">Top</option>
              <option value="middle">Middle</option>
              <option value="bottom" selected>Bottom</option>
            </select>
          </div>
          <select id="headingFont">
            <option value="Inter">Inter</option>
            <option value="Helvetica Neue">Helvetica Neue</option>
            <option value="Arial">Arial</option>
          </select>
          <select id="headingWeight">
            <option value="Regular">Regular</option>
            <option value="Medium">Medium</option>
            <option value="Semi Bold">Semi Bold</option>
            <option value="Bold">Bold</option>
          </select>
          <input type="number" id="headingSize" value="60" min="24" max="120" />
          <input type="color" id="headingColor" value="#000000" />
        </div>
      </div>
    </div>

    <!-- Description Section -->
    <div class="control-group">
      <div class="section-header">
        <div class="header-left">
          <label>Description</label>

        </div>
        <button class="toggle-button" id="toggleDescription" title="Toggle Description">
          <i class="ph-bold ph-eye-slash"></i>
          <span class="toggle-text">Show</span>
        </button>
      </div>
      <div class="description-section" id="descriptionSection">
        <textarea
          id="description"
          placeholder="Enter description text"
        ></textarea>
        <div class="row">
          <div class="position-input-group">
            <label>Position</label>
            <select id="descriptionPosition">
              <option value="below-heading" selected>Below Heading</option>
              <option value="above-heading">Above Heading</option>
            </select>
          </div>
          <select id="descriptionFont">
            <option value="Inter">Inter</option>
            <option value="Helvetica Neue">Helvetica Neue</option>
            <option value="Arial">Arial</option>
          </select>
          <select id="descriptionWeight">
            <option value="Regular">Regular</option>
            <option value="Medium">Medium</option>
            <option value="Semi Bold">Semi Bold</option>
            <option value="Bold">Bold</option>
          </select>
          <input
            type="number"
            id="descriptionSize"
            value="32"
            min="16"
            max="64"
          />
          <input type="color" id="descriptionColor" value="#000000" />
        </div>
      </div>
    </div>

    <!-- Add this after the description section -->
    <div class="control-group">
      <div class="section-header">
        <div class="header-left">
          <label>Tags</label>
        </div>
        <button class="toggle-button" id="toggleTags" title="Toggle Tags">
          <i class="ph-bold ph-eye-slash"></i>
          <span class="toggle-text">Show</span>
        </button>
      </div>
      <div class="tags-section" id="tagsSection">
        <div id="tagsList">
          <!-- Tag items will be added here dynamically -->
        </div>
        <button class="add-tag-button" id="addTagButton">
          <i class="ph-bold ph-plus"></i>
          Add Tag
        </button>
      </div>
    </div>

    <!-- Add this after the tags section -->
    <div class="control-group">
      <div class="section-header">
        <div class="header-left">
          <label>Contributors</label>
        </div>
        <button class="toggle-button" id="toggleContributors" title="Toggle Contributors">
          <i class="ph-bold ph-eye-slash"></i>
          <span class="toggle-text">Show</span>
        </button>
      </div>
      <div class="contributors-section" id="contributorsSection">
        <div id="contributorsList">
          <!-- Contributors will be added here dynamically -->
        </div>
        <div class="display-options">
          <label>Display Mode</label>
          <select id="contributorsDisplayMode" class="display-mode-select">
            <option value="avatars-only">Avatars Only</option>
            <option value="names-only">Names Only</option>
            <option value="both">Avatars & Names</option>
          </select>
        </div>
        <button class="add-contributor-button" id="addContributorButton">
          <i class="ph-bold ph-plus"></i>
          Add Contributor
        </button>
      </div>
    </div>

    <!-- Move the AI button and section before the button container -->
    <button id="askAI" class="ask-ai-button">
      <i class="ph-bold ph-magic-wand"></i>
      Ask AI to Create
    </button>

    <div id="aiSection" class="ai-section hidden">
      <textarea 
        id="aiPrompt" 
        placeholder="Describe your thumbnail (e.g., 'Create a thumbnail for a blog post about modern web development trends')"
        class="ai-prompt"
      ></textarea>
      <div class="ai-options">
        <label class="checkbox-label">
          <input type="checkbox" id="includeBackground" checked>
          Generate background image
        </label>
      </div>
      <button id="generateAI" class="ai-generate-button">
        <i class="ph-bold ph-magic-wand"></i>
        Generate with AI
      </button>
      <div id="aiStatus" class="ai-status"></div>
    </div>

    <!-- Keep the generate button at the very bottom -->
    <div class="button-container">
      <button id="generate">Generate Thumbnail</button>
    </div>

    <script>
      // Initialize state variables
      let isBackgroundActive = false;
      let isHeadingActive = false;
      let isDescriptionActive = false;
      let isTagsActive = false;
      let isContributorsActive = false;
      let tagCounter = 0;
      let contributorCounter = 0;

      // Get DOM elements
      const toggleBackground = document.getElementById("toggleBackground");
      const toggleHeading = document.getElementById("toggleHeading");
      const toggleDescription = document.getElementById("toggleDescription");
      const toggleTags = document.getElementById('toggleTags');
      const toggleContributors = document.getElementById('toggleContributors');

      const backgroundSection = document.getElementById("backgroundSection");
      const headingSection = document.getElementById("headingSection");
      const descriptionSection = document.getElementById("descriptionSection");
      const tagsSection = document.getElementById('tagsSection');
      const tagsList = document.getElementById('tagsList');
      const addTagButton = document.getElementById('addTagButton');
      const contributorsSection = document.getElementById('contributorsSection');
      const contributorsList = document.getElementById('contributorsList');
      const addContributorButton = document.getElementById('addContributorButton');
      const contributorsDisplayMode = document.getElementById('contributorsDisplayMode');

      // Scale factor for preview (280/1920 ≈ 0.14583333333333334)
      const SCALE_FACTOR = 0.14583333333333334;

      // Function to handle section toggle
      function toggleSection(button, section) {
        const isActive = !section.classList.contains("active");
        section.classList.toggle("active");
        button.classList.toggle("active");

        const icon = button.querySelector("i");
        const text = button.querySelector(".toggle-text");

        if (isActive) {
          icon.className = "ph-bold ph-eye";
          text.textContent = "Hide";
        } else {
          icon.className = "ph-bold ph-eye-slash";
          text.textContent = "Show";
        }

        return isActive;
      }

      // Add click event listeners for all toggle buttons
      toggleBackground.addEventListener("click", () => {
        isBackgroundActive = toggleSection(toggleBackground, backgroundSection);
        updatePreview();
      });

      toggleHeading.addEventListener("click", () => {
        isHeadingActive = toggleSection(toggleHeading, headingSection);
        updatePreview();
      });

      toggleDescription.addEventListener("click", () => {
        isDescriptionActive = toggleSection(toggleDescription, descriptionSection);
        updatePreview();
      });

      toggleTags.addEventListener('click', () => {
        isTagsActive = toggleSection(toggleTags, tagsSection);
        updatePreview();
      });

      toggleContributors.addEventListener('click', () => {
        isContributorsActive = toggleSection(toggleContributors, contributorsSection);
        updatePreview();
      });

      // Function to update preview
      function updatePreview() {
        const heading = document.getElementById("heading").value;
        const previewHeading = document.querySelector(".preview-heading");
        const previewDescription = document.querySelector(".preview-description");
        const previewCanvas = document.querySelector(".preview-canvas");

        // Update heading preview
        if (isHeadingActive) {
          previewHeading.style.display = "block";
          previewHeading.textContent = heading;
          previewHeading.style.fontSize = 
            parseInt(document.getElementById("headingSize").value) * SCALE_FACTOR + "px";
          previewHeading.style.fontFamily = document.getElementById("headingFont").value;
          previewHeading.style.fontWeight = 
            document.getElementById("headingWeight").value === "Bold" ? "700" : "400";
          previewHeading.style.color = document.getElementById("headingColor").value;
        } else {
          previewHeading.style.display = "none";
        }

        // Update description preview
        const description = document.getElementById("description").value;
        if (isDescriptionActive && description) {
          previewDescription.style.display = "block";
          previewDescription.textContent = description;
          previewDescription.style.fontSize = 
            parseInt(document.getElementById("descriptionSize").value) * SCALE_FACTOR + "px";
          previewDescription.style.fontFamily = document.getElementById("descriptionFont").value;
          previewDescription.style.fontWeight = 
            document.getElementById("descriptionWeight").value === "Bold" ? "700" : "400";
          previewDescription.style.color = document.getElementById("descriptionColor").value;
        } else {
          previewDescription.style.display = "none";
        }

        // Update background
        if (isBackgroundActive) {
          previewCanvas.style.backgroundColor = document.getElementById("backgroundColor").value;
          previewCanvas.classList.toggle(
            "with-gradient",
            document.getElementById("gradientOverlay").checked
          );
        } else {
          previewCanvas.style.backgroundColor = "#ffffff";
          previewCanvas.classList.remove("with-gradient");
        }
      }

      // Show heading section by default
      isHeadingActive = toggleSection(toggleHeading, headingSection);
      updatePreview();

      // Add event listeners for all inputs
      document.querySelectorAll('input, select, textarea').forEach(input => {
        input.addEventListener('input', updatePreview);
        input.addEventListener('change', updatePreview);
      });

      const generateButton = document.getElementById("generate");
      generateButton.onclick = () => {
        const heading = document.getElementById("heading").value;
        if (!heading) {
          alert("Heading is required!");
          return;
        }

        const description = isDescriptionActive
          ? document.getElementById("description").value
          : "";

        // Get heading styles
        const headingFont = document.getElementById("headingFont").value;
        const headingWeight = document.getElementById("headingWeight").value;
        const headingSize = parseInt(
          document.getElementById("headingSize").value
        );
        const headingColor = document.getElementById("headingColor").value;

        // Get description styles only if active
        const descriptionStyles = isDescriptionActive
          ? {
              font: document.getElementById("descriptionFont").value,
              weight: document.getElementById("descriptionWeight").value,
              size: parseInt(document.getElementById("descriptionSize").value),
              color: document.getElementById("descriptionColor").value,
            }
          : null;

        // Add background styles
        const backgroundStyles = {
          color: document.getElementById("backgroundColor").value,
          gradient: document.getElementById("gradientOverlay").checked,
        };

        // Get position information
        const headingPosition =
          document.getElementById("headingPosition").value;
        const descriptionPosition = document.getElementById(
          "descriptionPosition"
        ).value;

        // Get tags if active
        const tags = isTagsActive ? Array.from(document.querySelectorAll('.tag-item')).map(tag => ({
          text: tag.querySelector('.tag-text').value,
          position: tag.querySelector('.tag-position').value,
          fillColor: tag.querySelector('.tag-fill-color').value,
          textColor: tag.querySelector('.tag-text-color').value,
          radius: parseInt(tag.querySelector('.tag-radius').value),
          fontSize: parseInt(tag.querySelector('.tag-font-size').value),
          fontWeight: tag.querySelector('.tag-font-weight').value
        })) : [];

        // Get contributors if active
        const contributors = isContributorsActive ? Array.from(document.querySelectorAll('.contributor-item')).map(contributor => ({
          name: contributor.querySelector('.contributor-name').value,
          avatarUrl: contributor.querySelector('.contributor-avatar').src,
        })) : [];

        // Send message to plugin code
        parent.postMessage(
          {
            pluginMessage: {
              type: "generate-thumbnail",
              heading,
              description,
              styles: {
                heading: {
                  font: headingFont,
                  weight: headingWeight,
                  size: headingSize,
                  color: headingColor,
                  position: headingPosition,
                },
                description: descriptionStyles
                  ? {
                      ...descriptionStyles,
                      position: descriptionPosition,
                    }
                  : null,
                background: backgroundStyles,
                tags: tags.length > 0 ? tags : null,
                contributors: {
                  items: contributors,
                  displayMode: contributorsDisplayMode.value
                }
              },
            },
          },
          "*"
        );
      };

      // Function to create a new tag item
      function createTagItem() {
        const tagItem = document.createElement('div');
        tagItem.className = 'tag-item';
        tagItem.innerHTML = `
          <div class="tag-header">
            <span class="tag-title">Tag ${++tagCounter}</span>
            <button class="remove-tag" title="Remove Tag">
              <i class="ph-bold ph-x"></i>
            </button>
          </div>
          <input type="text" class="tag-text" placeholder="Enter tag text">
          <div class="row">
            <select class="tag-position">
              <option value="top">Top</option>
              <option value="above-heading">Above Heading</option>
              <option value="bottom">Bottom</option>
            </select>
          </div>
          <div class="tag-styles">
            <div class="row">
              <div class="color-group">
                <label>Fill Color</label>
                <input type="color" class="tag-fill-color" value="#E8F0FE">
              </div>
              <div class="color-group">
                <label>Text Color</label>
                <input type="color" class="tag-text-color" value="#1967D2">
              </div>
            </div>
            <div class="row">
              <div class="input-group">
                <label>Corner Radius</label>
                <input type="number" class="tag-radius" value="20" min="0" max="100">
              </div>
              <div class="input-group">
                <label>Font Size</label>
                <input type="number" class="tag-font-size" value="20" min="8" max="72">
              </div>
            </div>
            <div class="row">
              <div class="input-group">
                <label>Font Weight</label>
                <select class="tag-font-weight">
                  <option value="Regular">Regular</option>
                  <option value="Medium">Medium</option>
                  <option value="Bold">Bold</option>
                </select>
              </div>
            </div>
          </div>
        `;

        // Add styles for the new controls
        const styles = document.createElement('style');
        styles.textContent = `
          .tag-styles {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #eee;
          }
          .color-group, .input-group {
            flex: 1;
          }
          .color-group label, .input-group label {
            display: block;
            font-size: 11px;
            margin-bottom: 4px;
            color: #666;
          }
          .tag-styles input[type="number"] {
            width: 100%;
          }
        `;
        document.head.appendChild(styles);

        // Add remove tag handler
        tagItem.querySelector('.remove-tag').onclick = () => {
          tagItem.remove();
          updatePreview();
        };

        // Add change listeners for tag inputs
        tagItem.querySelectorAll('input, select').forEach(input => {
          input.addEventListener('change', updatePreview);
          input.addEventListener('input', updatePreview);
        });

        return tagItem;
      }

      // Add tag button handler
      addTagButton.onclick = () => {
        tagsList.appendChild(createTagItem());
        updatePreview();
      };

      // Function to create a new contributor item
      function createContributorItem() {
        const contributorItem = document.createElement('div');
        contributorItem.className = 'contributor-item';
        
        // Generate a random seed for the avatar
        const seed = Math.random().toString(36).substring(7);
        const avatarUrl = `https://api.dicebear.com/7.x/avataaars/svg?seed=${seed}`;
        
        contributorItem.innerHTML = `
          <div class="contributor-header">
            <div class="contributor-preview">
              <img src="${avatarUrl}" class="contributor-avatar" alt="Avatar">
              <span class="contributor-title">Contributor ${++contributorCounter}</span>
            </div>
            <button class="remove-contributor" title="Remove Contributor">
              <i class="ph-bold ph-x"></i>
            </button>
          </div>
          <input type="text" class="contributor-name" placeholder="Enter contributor name">
        `;

        // Add remove handler
        contributorItem.querySelector('.remove-contributor').onclick = () => {
          contributorItem.remove();
          updatePreview();
        };

        // Add change listeners
        contributorItem.querySelectorAll('input, select').forEach(input => {
          input.addEventListener('change', updatePreview);
          input.addEventListener('input', updatePreview);
        });

        return contributorItem;
      }

      // Add contributor button handler
      addContributorButton.onclick = () => {
        contributorsList.appendChild(createContributorItem());
        updatePreview();
      };

      // AI section handlers
      const aiSection = document.getElementById('aiSection');
      const askAIButton = document.getElementById('askAI');
      const aiPromptInput = document.getElementById('aiPrompt');
      const generateAIButton = document.getElementById('generateAI');
      const includeBackgroundCheck = document.getElementById('includeBackground');
      const aiStatus = document.getElementById('aiStatus');

      // Toggle AI section
      askAIButton.onclick = () => {
        aiSection.classList.toggle('hidden');
        if (!aiSection.classList.contains('hidden')) {
          aiPromptInput.focus();
        }
      };

      // Generate with AI
      generateAIButton.onclick = async () => {
        const prompt = aiPromptInput.value.trim();
        if (!prompt) {
          aiStatus.textContent = 'Please enter a prompt';
          aiStatus.className = 'ai-status error';
          return;
        }

        try {
          aiStatus.innerHTML = '<i class="ph-bold ph-circle-notch ph-spin"></i> Generating thumbnail...';
          aiStatus.className = 'ai-status loading';
          generateAIButton.disabled = true;

          parent.postMessage({ 
            pluginMessage: { 
              type: 'generate-ai-thumbnail',
              prompt,
              includeBackground: includeBackgroundCheck.checked
            }
          }, '*');
        } catch (error) {
          aiStatus.textContent = 'Error generating thumbnail: ' + error.message;
          aiStatus.className = 'ai-status error';
          generateAIButton.disabled = false;
        }
      };

      // Update the message handler
      window.onmessage = async (event) => {
        if (event.data.pluginMessage.type === 'ai-generation-complete') {
          aiStatus.textContent = 'Thumbnail generated successfully!';
          aiStatus.className = 'ai-status success';
          generateAIButton.disabled = false;
          
          // Update the form with generated content
          document.getElementById('heading').value = event.data.pluginMessage.heading;
          document.getElementById('description').value = event.data.pluginMessage.description;
          if (event.data.pluginMessage.backgroundColor) {
            document.getElementById('backgroundColor').value = event.data.pluginMessage.backgroundColor;
          }
          
          // Hide AI section after a short delay
          setTimeout(() => {
            aiSection.classList.add('hidden');
            aiPromptInput.value = '';
            aiStatus.textContent = '';
            aiStatus.className = 'ai-status';
          }, 1500);
          
          // Trigger preview update
          updatePreview();
        } else if (event.data.pluginMessage.type === 'ai-generation-error') {
          aiStatus.textContent = 'Error: ' + event.data.pluginMessage.error;
          aiStatus.className = 'ai-status error';
          generateAIButton.disabled = false;
        }
      };
    </script>
  </body>
</html>
